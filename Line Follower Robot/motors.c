#include "motors.h"

#include "gpio.h"
#include "stm32f10x.h"

void pwm_clock(void)
{
		RCC->APB1ENR |= RCC_APB1ENR_TIM4EN; //clock enable for tim15
		RCC->APB2ENR |= RCC_APB2ENR_IOPAEN | RCC_APB2ENR_IOPBEN; //clock enable for port A anb B
		RCC->APB2ENR |= RCC_APB2ENR_AFIOEN; // clock enable for afio

		GPIOB->CRL |= GPIO_CRL_CNF6_1 | GPIO_CRL_MODE6; //rear left 
		GPIOB->CRL &= ~GPIO_CRL_CNF6_0;

		GPIOB->CRL |= GPIO_CRL_CNF7_1 | GPIO_CRL_MODE7; //front left
		GPIOB->CRL &= ~GPIO_CRL_CNF7_0;

		GPIOB->CRH |= GPIO_CRH_CNF8_1 | GPIO_CRH_MODE8; //rear right
		GPIOB->CRH &= ~GPIO_CRH_CNF8_0;

		GPIOB->CRH |= GPIO_CRH_CNF9_1 | GPIO_CRH_MODE9; //front right
		GPIOB->CRH &= ~GPIO_CRH_CNF9_0;

		RCC->APB2ENR |= RCC_APB2ENR_IOPAEN | RCC_APB2ENR_IOPBEN | RCC_APB2ENR_IOPCEN;
}

void tim4pwm_init(void)
{
		TIM4->CR1 |= TIM_CR1_CEN;
		TIM4->CR2 |= TIM_CR2_OIS1;
		TIM4->CR2 |= TIM_CR2_OIS2;
		TIM4->CR2 |= TIM_CR2_OIS3;
		TIM4->CR2 |= TIM_CR2_OIS4;
		TIM4->EGR |= TIM_EGR_UG;

		TIM4->CCMR1 |= TIM_CCMR1_OC1M_2 | TIM_CCMR1_OC1M_1 | TIM_CCMR1_OC1PE | TIM_CCMR1_OC1FE;
		TIM4->CCMR1 |= TIM_CCMR1_OC2M_2 | TIM_CCMR1_OC2M_1 | TIM_CCMR1_OC2PE | TIM_CCMR1_OC2FE;
		TIM4->CCMR2 |= TIM_CCMR2_OC3M_2 | TIM_CCMR2_OC3M_1 | TIM_CCMR2_OC3PE | TIM_CCMR2_OC3FE;
		TIM4->CCMR2 |= TIM_CCMR2_OC4M_2 | TIM_CCMR2_OC4M_1 | TIM_CCMR2_OC4PE | TIM_CCMR2_OC4FE;

		TIM4->CCER |= TIM_CCER_CC1E;
		TIM4->CCER |= TIM_CCER_CC2E;
		TIM4->CCER |= TIM_CCER_CC3E;
		TIM4->CCER |= TIM_CCER_CC4E;
		TIM4->PSC = 2399;
		TIM4->ARR = 100;
		TIM4->CCR1 = 0;
		TIM4->CCR2 = 0;
		TIM4->CCR3 = 0;
		TIM4->CCR4 = 0;
		TIM4->BDTR |= TIM_BDTR_MOE | TIM_BDTR_OSSI;
		TIM4->CR1 |= TIM_CR1_ARPE | TIM_CR1_CEN;
}	

void motor_clock(void)
{
	 RCC->APB2ENR |= RCC_APB2ENR_IOPAEN | RCC_APB2ENR_IOPBEN | RCC_APB2ENR_IOPCEN; //clock enable for port A anb B
		 
		GPIOA->CRL |= GPIO_CRL_MODE6 | GPIO_CRL_MODE7; 
		GPIOA->CRL &= ~GPIO_CRL_CNF6 & ~GPIO_CRL_CNF7;

		GPIOA->CRH |= GPIO_CRH_MODE9 | GPIO_CRH_MODE10 | GPIO_CRH_MODE11 | GPIO_CRH_MODE12; 
		GPIOA->CRH &= ~GPIO_CRH_CNF9 & ~GPIO_CRH_CNF10 & ~GPIO_CRH_CNF11 & ~GPIO_CRH_CNF12;
	 
		GPIOC->CRH |= GPIO_CRH_MODE10 | GPIO_CRH_MODE11; 
		GPIOC->CRH &= ~GPIO_CRH_CNF10 & ~GPIO_CRH_CNF11;
}

void move_forward(void)
{
		GPIOA->ODR |= GPIO_ODR_ODR11 | GPIO_ODR_ODR9 | GPIO_ODR_ODR6;
		GPIOA->ODR &= ~GPIO_ODR_ODR12 & ~GPIO_ODR_ODR10 & ~GPIO_ODR_ODR7;
	
		GPIOC->ODR = GPIO_ODR_ODR10;
		GPIOC->ODR = ~GPIO_ODR_ODR11;
		//GPIOA->ODR = 0x00000A40;
		//GPIOC->ODR = 0x00000400;
		TIM4->CCR1 = 28;
    TIM4->CCR2 = 28;
    TIM4->CCR3 = 28;
    TIM4->CCR4 = 28;
}

void move_backward(void)
{
		GPIOA->ODR |= GPIO_ODR_ODR12 | GPIO_ODR_ODR10 | GPIO_ODR_ODR7;
		GPIOA->ODR &= ~GPIO_ODR_ODR11 & ~GPIO_ODR_ODR9 & ~GPIO_ODR_ODR6;
	
		GPIOC->ODR = GPIO_ODR_ODR11;
		GPIOC->ODR = ~GPIO_ODR_ODR10;
		//GPIOA->ODR = 0x00001480;
		//GPIOC->ODR = 0x00000800;
		TIM4->CCR1 = 40;
    TIM4->CCR2 = 40;
    TIM4->CCR3 = 40;
    TIM4->CCR4 = 40;
}

void move_right(void)
{	
		GPIOA->ODR = GPIO_ODR_ODR11;
		GPIOA->ODR &= ~GPIO_ODR_ODR12 & ~GPIO_ODR_ODR10 & ~GPIO_ODR_ODR9 & ~GPIO_ODR_ODR7 & ~GPIO_ODR_ODR6;
	
		GPIOC->ODR = GPIO_ODR_ODR10;
		GPIOC->ODR = ~GPIO_ODR_ODR11;
		//GPIOA->ODR = 0x00000800;
		//GPIOC->ODR = 0x00000400;
		TIM4->CCR1 = 99;
    TIM4->CCR2 = 99;
    TIM4->CCR3 = 99;
    TIM4->CCR4 = 99;
}

void sharp_right(void)
{	
		GPIOA->ODR = GPIO_ODR_ODR11 | GPIO_ODR_ODR10 | GPIO_ODR_ODR7;
		GPIOA->ODR &= ~GPIO_ODR_ODR12 & ~GPIO_ODR_ODR9 & ~GPIO_ODR_ODR6;
	
		GPIOC->ODR = GPIO_ODR_ODR10;
		GPIOC->ODR = ~GPIO_ODR_ODR11;
		//GPIOA->ODR = 0x00000800;
		//GPIOC->ODR = 0x00000400;
		TIM4->CCR1 = 99;
    TIM4->CCR2 = 80;
    TIM4->CCR3 = 40;
    TIM4->CCR4 = 40;
}

void move_left(void)
{
		GPIOA->ODR |= GPIO_ODR_ODR9 | GPIO_ODR_ODR6;
		GPIOA->ODR &= ~GPIO_ODR_ODR12 & ~GPIO_ODR_ODR11 & ~GPIO_ODR_ODR10 & ~GPIO_ODR_ODR7;
	
		GPIOC->ODR &= ~GPIO_ODR_ODR11 & ~GPIO_ODR_ODR10;
		
		//GPIOA->ODR = 0x00000240;
		//GPIOC->ODR = 0x00000000;
		TIM4->CCR1 = 99;
    TIM4->CCR2 = 99;
    TIM4->CCR3 = 99;
    TIM4->CCR4 = 99;
}

void sharp_left(void)
{
		GPIOA->ODR |= GPIO_ODR_ODR12 | GPIO_ODR_ODR9 | GPIO_ODR_ODR6;
		GPIOA->ODR &= ~GPIO_ODR_ODR11 & ~GPIO_ODR_ODR10 & ~GPIO_ODR_ODR7;
	
		GPIOC->ODR = GPIO_ODR_ODR11;
		GPIOC->ODR = ~GPIO_ODR_ODR10;
		
		//GPIOA->ODR = 0x00000240;
		//GPIOC->ODR = 0x00000000;
		TIM4->CCR1 = 99;
    TIM4->CCR2 = 80;
    TIM4->CCR3 = 40;
    TIM4->CCR4 = 40;
}

void move_stop(void)
{
		GPIOA->ODR = 0x00000000;
		GPIOC->ODR = 0x00000000;
		TIM4->CCR1 = 40;
    TIM4->CCR2 = 40;
    TIM4->CCR3 = 40;
    TIM4->CCR4 = 40;
}

void left(void)
{
	move_left();
	delay(1300000);
}